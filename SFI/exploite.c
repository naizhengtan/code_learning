#include "stdio.h"
#include "stdlib.h"

void f(int arg, int arg1, int arg2, int arg3){
	printf("location for arg %x\n",&arg);
	asm volatile ( "mov %0, 0(%%esp); "
		"mov %0, -4(%%esp); "
		"mov %0, -8(%%esp); "
		"mov %0, 4(%%esp); "
		"mov %0, 8(%%esp); "
		"mov %0, -12(%%esp);"
		 : : "r"(arg) : );
	return;
}

static __inline unsigned int 
read_esp(void) 
{                                                                                            
	unsigned int esp;
	__asm __volatile("movl %%esp,%0" : "=r" (esp));                                          
	return esp;
} 

void poke(int* loc, int val) {
	int local;
	printf("location for local %x target %x\n",&local, loc);
	unsigned int diff = &local - loc - 2;
	for (diff/=4;diff;diff--){
		alloca(16);
	}
	printf("esp %x \n",read_esp());
	f(val,val,val,val);
}

int main(){
	int *a = malloc(sizeof(int));
	*a = 1;
	printf("location for a %x\n",a);

	poke(a,2);
	printf("%d\n",*a);
}
